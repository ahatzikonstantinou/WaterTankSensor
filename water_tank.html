$def with(settings, defaults, pnames, snames, water_tank_id, show_settings)

$var title: $_('SIP Water-Tank Plugin')
$var page: water_tank_plugin  
<script>
function decode(str) {

let txt = new DOMParser().parseFromString(str, "text/html");

return txt.documentElement.textContent;

}

const WaterTankState = {
    NORMAL : 1,
    OVERFLOW : 2,
    OVERFLOW_UNSAFE : 3,
    WARNING : 4,
    WARNING_UNSAFE : 5,
    CRITICAL : 6,
    CRITICAL_UNSAFE : 7
}

function getWaterTankStateName(stateValue)
{
    switch(stateValue){
        case 1: return "NORMAL";
        case 2: return "OVERFLOW";
        case 3: return "OVERFLOW_UNSAFE";
        case 4: return "WARNING";
        case 5: return "WARNING_UNSAFE";
        case 6: return "CRITICAL";
        case 7: return "CRITICAL_UNSAFE";
        default:
            console.log("Unknown WaterTankState " + stateValue);
            return null;
    }
}

    var defaults = JSON.parse(decode("$defaults"));
    // console.log(defaults);
    var water_tank_data;
    
    // Initialize behaviors
    jQuery(document).ready(function(){

        jQuery("details").prop("open", ${"true" if show_settings else "false" });

        // add click event explicitly to stop form submit
        let form = document.querySelector('#pluginFormSettings');
        form.addEventListener('submit', function () {
            // Ignore the #sensorLog button
            if (event.submitter.matches('#sensorLog')) {
                event.preventDefault();
                window.location = "/water_plugin_sensor_log"; 
            }
        });

        jQuery("#cUpdateSettings").click(function() {
            jQuery("#pluginFormSettings").valid();
            // jQuery("#pluginFormSettings").submit();
        });

        jQuery("#cAddNew").click(function() {
            jQuery("#original_water_tank_id").val("");            
            jQuery("#pluginFormWaterTanks").submit();
        });


        // uncomment for debugging only, stops form submit to be able to see validation errors
        // document.querySelector('#pluginFormWaterTanks').addEventListener('submit', function () {
        //     // Ignore the #sensorLog button
        //     if (event.submitter.matches('#cUpdate')) {
        //         event.preventDefault();
        //     }
        // });


        jQuery("#cUpdate").click(function() {
            if(jQuery("#original_water_tank_id").val().trim().length === 0)
            {
                if(!confirm("$_('No water tank will be updated because no water tank was selected.')"))
                {
                    return;
                }
                jQuery("#action").val("update");            
                jQuery("#pluginFormWaterTanks")[0].submit(); // to avoid validation of tank data fields
                return;
            }

            jQuery("#pluginFormWaterTanks").valid();
        });

        jQuery("button#cDelete").click(function(){
            jQuery("#pluginFormWaterTanks").attr('action', '/water-tank-delete');
            jQuery("#pluginFormWaterTanks").submit();
        });

        jQuery("button#cCancel").click(function(){
            window.location="/";
        });

        jQuery("button#docButton").click(function(){
            window.open("static/docs/plugins/water-tank-plugin-docs.html", "_blank");
        });

        // console.log('Getting all water tank data');
        jQuery.getJSON('water-tank-get-all', function(data){
            console.log('data:', data);
            water_tank_data = data;
            console.log('water_tank_data:', water_tank_data);

            $if water_tank_id:
                getWaterTankData("$water_tank_id");
            $else:
                jQuery("input[name=type][value=1]").click();
        });        

        
        //
        // Register mqtt client to update water tank data based on incoming mqtt messages
        // Create a client instance
        jQuery.getJSON('water-tank-get_mqtt_settings', function(data)
        {
            let mqtt_settings = null;
        
            console.log('mqtt_settings: ', data);
            mqtt_settings = data;

            const client_id = "browser_" + uuidv4();
            console.log('water_tank.html connecting to mqtt broker with ' +
            mqtt_settings.broker_host + ", " + mqtt_settings.mqtt_broker_ws_port + ", " + client_id);
            water_plugin_client = new Paho.MQTT.Client(mqtt_settings.broker_host, mqtt_settings.mqtt_broker_ws_port, client_id);

            // set callback handlers
            water_plugin_client.onConnectionLost = onConnectionLost;
            water_plugin_client.onMessageArrived = onMessageArrived;

            // connect the client
            water_plugin_client.connect({onSuccess:onConnect});

            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                console.log("onConnect");
                water_plugin_client.subscribe(mqtt_settings.data_publish_mqtt_topic);
            }

            // called when the client loses its connection
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("onConnectionLost:"+responseObject.errorMessage);
                }
            }

            // called when a message arrives
            function onMessageArrived(message) {
                //console.log("onMessageArrived:"+message.payloadString);
                try
                {
                    const water_tanks = JSON.parse(message.payloadString);
                    console.log('Received MQTT message:', water_tanks);  
                    Object.keys(water_tanks).forEach(e => {
                        console.log(`key= $${e} value=$${water_tanks[e]}`);
                        const id = e;
                        const water_tank = water_tanks[e];
                        console.log('id: ' + id + ", water_tank: ", water_tank);
                        let td = jQuery("td").filter(function() {
                            return $$(this).text() === id;
                        });
                        //console.log('td: ', td.text());
                        td.removeClass();
                        td.addClass(DetermineWaterTankState(water_tank));
                        if(water_tank.percentage != null)
                        {
                            td.nextAll().eq(1).text(Math.round(water_tank.percentage)+"%");
                            td.nextAll().eq(2).text(water_tank.last_updated);
                        }

                        jQuery("#last_updated").val(water_tank.last_updated);
                        jQuery("#invalid_sensor_measurement").css({ visibility: (water_tank.invalid_sensor_measurement? "visible" : "hidden")});
                        jQuery("#percentage").val(water_tank.percentage != null ? Math.round(water_tank.percentage) : "");

                        console.log("Checking whether to flash a state original_id:" +
                            jQuery("#original_water_tank_id").val() +
                            ", against id: " + water_tank.id);
                        if(jQuery("#original_water_tank_id").val() == water_tank.id)
                        {
                            if([WaterTankState.OVERFLOW, WaterTankState.OVERFLOW_UNSAFE].includes(water_tank.state))
                            {
                                console.log("Flashing OVERFLOW");
                                jQuery("[name=overflow_flash]").show();
                                jQuery("#overflow_revert_button").prop('disabled', false);
                            }
                            else
                            {
                                console.log("Hiding OVERFLOW");
                                jQuery("[name=overflow_flash]").hide();
                                jQuery("#overflow_revert_button").prop('disabled', true);
                            }
                            if([WaterTankState.WARNING, WaterTankState.WARNING_UNSAFE].includes(water_tank.state))
                            {
                                console.log("Flashing WARNING");
                                jQuery("[name=warning_flash]").show();
                                jQuery("#warning_revert_button").prop('disabled', false);
                            }
                            else
                            {
                                console.log("Hiding WARNING");
                                jQuery("[name=warning_flash]").hide();
                                jQuery("#warning_revert_button").prop('disabled', true);
                            }
                            if([WaterTankState.CRITICAL, WaterTankState.CRITICAL_UNSAFE].includes(water_tank.state))
                            {
                                console.log("Flashing CRITICAL");
                                jQuery("[name=critical_flash]").show();
                                jQuery("#critical_revert_button").prop('disabled', false);
                            }
                            else
                            {
                                console.log("Hiding CRITICAL");
                                jQuery("[name=critical_flash]").hide();
                                jQuery("#critical_revert_button").prop('disabled', true);
                            }
                        }
                    });
                }
                catch(e)
                {
                    console.error(e);
                }
            }
        });
        
        jQuery("#water-tank-up,#water-tank-down").on( "click", function(event){
            let row = jQuery(this).parents("tr:first");

            let id = jQuery(row).children().eq(0).text();
            
            let beforeIndex = jQuery(row).index();
            console.log("Before row index: " + jQuery(row).index());

            let move = "down";

            if (jQuery(this).is("#water-tank-up")) {
                row.insertBefore(row.prev());
            } else {
                row.insertAfter(row.next());
                move = "up";
            }
            console.log("After row index: " + jQuery(row).index());
            let afterIndex = jQuery(row).index();
            if(beforeIndex != afterIndex)
            {
                jQuery.post('water-tank-save-order', { water_tank_id: id, move: move, order : afterIndex }, 
                    function(returnedData){
                        console.log(returnedData);
                    }, 'json'
                );
            }
        });
               
        jQuery.validator.addMethod("messageRule", function(value, element) {
            let keywords = value.match(/{(.*?)}/g);    // capture all words between curly brackets, will include the curly brackets
            let allowedKeywords = ["water_tank_id", "water_tank_label", "sensor_id", "percentage", "measurement", "last_updated", "mqtt_topic", "additional_info"];
            
            let excludeKeywordsStr = jQuery("#"+element.id).data("exclude-keywords");            
            let excludeKeywords = [];
            if( excludeKeywordsStr != null && excludeKeywordsStr.length > 0 )
            {
                excludeKeywords = excludeKeywordsStr.split(',');
            }
            
            let extraKeywordsStr = jQuery("#"+element.id).data("extra-keywords");
            if( extraKeywordsStr != null && extraKeywordsStr.length > 0 )
            {
                allowedKeywords = allowedKeywords.concat(extraKeywordsStr.split(','));
            }
            
            let invalidKeywords = [];
            
            console.log("Validating against valid keywords: {" + allowedKeywords.join("}, {") + "}" );
            for(const kw of keywords)
            {
                let invalidKeywordFound = false;
                let keyword = kw.substring(1, kw.length - 1); // remove the curly brackets
                // console.log(`Index of $${keyword} in allowedKeywords is ` + allowedKeywords.indexOf(`$${keyword}`));
                invalidKeywordFound = allowedKeywords.indexOf(`$${keyword}`) == -1 || excludeKeywords.indexOf(`$${keyword}`) != -1;
                if( invalidKeywordFound )
                {
                    invalidKeywords.push(kw);
                }
            }
            jQuery.validator.messages.messageRule = "Invalid keywords: " + invalidKeywords.join();
            return this.optional(element) || (invalidKeywords.length == 0);
        });
        
        jQuery("#pluginFormSettings").validate({
            rules: {
                unrecognised_msg: { messageRule: true },
                xmpp_unassociated_sensor_msg: { messageRule: true },
                xmpp_invalid_sensor_measurement_msg: { messageRule: true },
                xmpp_overflow_msg: { messageRule: true },
                xmpp_warning_msg: { messageRule: true },
                xmpp_critical_msg: { messageRule: true },
                water_loss_msg: { messageRule: true },
                email_recipients: {
                    pattern: /^[\W]*([\w+\-.%]+@[\w\-.]+\.[A-Za-z]{2,4}[\W]*,{1}[\W]*)*([\w+\-.%]+@[\w\-.]+\.[A-Za-z]{2,4})[\W]*$$/
                }
            },
            messages: {
                email_recipients: {
                    pattern: "Comma separated list of email addresses"
                }
            }
        });
        
        jQuery.validator.addMethod("greaterThan", function (value, element, param) {
            let otherElement = jQuery(param);
            if(otherElement.val().trim().length == 0 || jQuery(element).val().trim().length == 0)
            {
                return true;
            }
            return parseInt(value, 10) > parseInt(otherElement.val(), 10);
        });
        
        jQuery.validator.addMethod("lessThan", function (value, element, param) {
            let otherElement = jQuery(param);
            if(otherElement.val().trim().length == 0 || jQuery(element).val().trim().length == 0)
            {
                return true;
            }
            return parseInt(value, 10) < parseInt(otherElement.val(), 10);
        });
        
        jQuery.validator.addMethod("timeOrPercentage", function(value, element) {
            if(!jQuery(element).is(":checked"))
            {
                return true;
            }
            time = jQuery(element).closest("div[class=station").find("input[type=number]").first().val();
            //percentage = jQuery(element).closest("div[class=station").find("input[type=number]").last().val();

            return time.trim().length > 0; // || percentage.length > 0;
            },
            "Specify Time"
        );

        jQuery.validator.addClassRules("station_run", {
            timeOrPercentage: true
        });

        jQuery("#pluginFormWaterTanks").validate({
            rules: {
                id: {
                    pattern: /^[a-zA-Z0-9_]+$$/
                },
                overflow_safe_level: {
                    number: true,
                    lessThan: "#overflow_level"
                },
                warning_safe_level: {
                    number: true,
                    greaterThan: "#warning_level"
                },
                critical_safe_level: {
                    number: true,
                    greaterThan: "#critical_level"
                }
            },
            messages: {
                id: {
                    pattern: 'Only letters, numbers, and underscores are allowed'
                },
                overflow_safe_level: {
                    lessThan: "Overflow safe level must be less than overflow level"
                },
                warning_safe_level: {
                    greaterThan: "Warning safe level must be greater than warning level"
                },
                critical_safe_level: {
                    greaterThan: "Critical safe level must be greater than critical level"
                }
            },
            errorPlacement: function(error, element) {
                if(jQuery(element).hasClass("station_run"))
                {
                    error.insertAfter(jQuery(element).parent());
                }
                else
                {
                    error.insertAfter(element)
                }
            }
        });
        
    });

    function getWaterTankData(id)
    {
        console.log('Getting water tank data for id :', id);
        // console.log('water_tank_data:', water_tank_data);
        let water_tank = water_tank_data.find( w => {
            return w.id === id;
        });
        console.log('From water_tank_data: ', water_tank);
        // console.log(jQuery("#id_"+id).text());
        // console.log(jQuery("#enabled_"+id).is(":checked"));
        jQuery("#id").val(water_tank.id);
        jQuery("#original_water_tank_id").val(water_tank.id);
        jQuery("#label").val(water_tank.label);
        jQuery("#enabled").prop('checked', water_tank.enabled);
        jQuery("input[name=type][value=" + water_tank.type + "]").click();
        jQuery("input[name=water_tank_units][value=" + water_tank.water_tank_units + "]").click();
        jQuery("input[name=sensor_units][value=" + water_tank.sensor_units + "]").click();

        jQuery("#width").val(water_tank.width);
        jQuery("#length").val(water_tank.length);
        jQuery("#diameter").val(water_tank.diameter);
        jQuery("#height").val(water_tank.height);
        jQuery("#horizontal_axis").val(water_tank.horizontal_axis);
        jQuery("#vertical_axis").val(water_tank.vertical_axis);
        
        jQuery("#sensor_mqtt_topic").val(water_tank.sensor_mqtt_topic);
        jQuery("#invalid_sensor_measurement_email").prop('checked', water_tank.invalid_sensor_measurement_email);
        jQuery("#invalid_sensor_measurement_xmpp").prop('checked', water_tank.invalid_sensor_measurement_xmpp);
        jQuery("#sensor_id").val(water_tank.sensor_id);
        jQuery("#sensor_offset_from_top").val(water_tank.sensor_offset_from_top);
        jQuery("#min_valid_sensor_measurement").val(water_tank.min_valid_sensor_measurement);
        jQuery("#max_valid_sensor_measurement").val(water_tank.max_valid_sensor_measurement);
        jQuery("#sensor_measurement").val(water_tank.sensor_measurement);
        jQuery("#last_updated").val(water_tank.last_updated);
        jQuery("#invalid_sensor_measurement").css({ visibility: (water_tank.invalid_sensor_measurement? "visible" : "hidden")});
        jQuery("#percentage").val(Math.round(water_tank.percentage));

        if([WaterTankState.OVERFLOW, WaterTankState.OVERFLOW_UNSAFE].includes(water_tank.state))
        {
            jQuery("[name=overflow_flash]").show();
            jQuery("#overflow_revert_button").prop('disabled', false);
        }
        else
        {
            jQuery("[name=overflow_flash]").hide();
            jQuery("#overflow_revert_button").prop('disabled', true);
        }
        jQuery("#overflow_level").val(water_tank.overflow_level);
        jQuery("#overflow_email").prop('checked', water_tank.overflow_email);
        jQuery("#overflow_xmpp").prop('checked', water_tank.overflow_xmpp);
        jQuery("#overflow_safe_level").val(water_tank.overflow_safe_level);

        if([WaterTankState.WARNING, WaterTankState.WARNING_UNSAFE].includes(water_tank.state))
        {
            jQuery("[name=warning_flash]").show();
            jQuery("#warning_revert_button").prop('disabled', false);
        }
        else
        {
            jQuery("[name=warning_flash]").hide();
            jQuery("#warning_revert_button").prop('disabled', true);
        }
        jQuery("#warning_level").val(water_tank.warning_level);
        jQuery("#warning_safe_level").val(water_tank.warning_safe_level);
        jQuery("#warning_email").prop('checked', water_tank.warning_email);
        jQuery("#warning_xmpp").prop('checked', water_tank.warning_xmpp);        
        
        if([WaterTankState.CRITICAL, WaterTankState.CRITICAL_UNSAFE].includes(water_tank.state))
        {
            jQuery("[name=critical_flash]").show();
            jQuery("#critical_revert_button").prop('disabled', false);
        }
        else
        {
            jQuery("[name=critical_flash]").hide();
            jQuery("#critical_revert_button").prop('disabled', true);
        }
        jQuery("#critical_level").val(water_tank.critical_level);
        jQuery("#critical_safe_level").val(water_tank.critical_safe_level);
        jQuery("#critical_email").prop('checked', water_tank.critical_email);
        jQuery("#critical_xmpp").prop('checked', water_tank.critical_xmpp);

        $for i in range(0, len(pnames)):
            jQuery("#overflow_pr_run_$i").prop('checked', water_tank.overflow_programs["$i"].run);
            jQuery("#overflow_pr_enable_$i").prop('checked', water_tank.overflow_programs["$i"].enable);
            jQuery("#overflow_pr_suspend_$i").prop('checked', water_tank.overflow_programs["$i"].suspend);
            jQuery("#warning_pr_run_$i").prop('checked', water_tank.warning_programs["$i"].run);
            jQuery("#warning_pr_enable_$i").prop('checked', water_tank.warning_programs["$i"].enable);
            jQuery("#warning_pr_suspend_$i").prop('checked', water_tank.warning_programs["$i"].suspend);
            jQuery("#critical_pr_run_$i").prop('checked', water_tank.critical_programs["$i"].run);
            jQuery("#critical_pr_enable_$i").prop('checked', water_tank.critical_programs["$i"].enable);
            jQuery("#critical_pr_suspend_$i").prop('checked', water_tank.critical_programs["$i"].suspend);
        
        $for i in range(0, len(snames)):
        $ show = (gv.sd['show'][i//8]>>(i%8))&1
            $if show == 1:
            jQuery("#overflow_sn_run_$i").prop('checked', water_tank.overflow_stations["$i"].run);
            jQuery("#overflow_sn_minutes_$i").val(water_tank.overflow_stations["$i"].minutes);
            jQuery("#overflow_sn_percentage_$i").val(water_tank.overflow_stations["$i"].percentage);
            jQuery("#overflow_sn_stop_on_exit_$i").prop('checked', water_tank.overflow_stations["$i"].stop_on_exit);
            jQuery("#warning_sn_run_$i").prop('checked', water_tank.warning_stations["$i"].run);
            jQuery("#warning_sn_minutes_$i").val(water_tank.warning_stations["$i"].minutes);
            jQuery("#warning_sn_percentage_$i").val(water_tank.warning_stations["$i"].percentage);
            jQuery("#warning_sn_stop_on_exit_$i").prop('checked', water_tank.warning_stations["$i"].stop_on_exit);
            jQuery("#critical_sn_run_$i").prop('checked', water_tank.critical_stations["$i"].run);
            jQuery("#critical_sn_minutes_$i").val(water_tank.critical_stations["$i"].minutes);
            jQuery("#critical_sn_percentage_$i").val(water_tank.critical_stations["$i"].percentage);
            jQuery("#critical_sn_stop_on_exit_$i").prop('checked', water_tank.critical_stations["$i"].stop_on_exit);

        jQuery("#loss_email").prop('checked', water_tank.loss_email);
        jQuery("#loss_xmpp").prop('checked', water_tank.loss_xmpp);

        jQuery("button#cUpdate").prop('disabled', false);        
        jQuery("button#cDelete").prop('disabled', false);        
    }

    function typeSelected(type)
    {
        switch(type)
        {
            case 1: //RECTANGULAR
                jQuery("#width").show(); jQuery("#width").parent().show();jQuery("#width").parent().prev().show();jQuery("#width").prop('required',true);
                jQuery("#length").show(); jQuery("#length").parent().show();jQuery("#length").parent().prev().show();jQuery("#length").prop('required',true);
                jQuery("#diameter").hide(); jQuery("#diameter").parent().hide();jQuery("#diameter").parent().prev().hide();jQuery("#diameter").prop('required',false);
                jQuery("#height").show(); jQuery("#height").parent().show();jQuery("#height").parent().prev().show();jQuery("#height").prop('required',true);
                jQuery("#horizontal_axis").hide(); jQuery("#horizontal_axis").parent().hide();jQuery("#horizontal_axis").parent().prev().hide();jQuery("#horizontal_axis").prop('required',false);
                jQuery("#vertical_axis").hide(); jQuery("#vertical_axis").parent().hide();jQuery("#vertical_axis").parent().prev().hide();jQuery("#vertical_axis").prop('required',false);
                break;
            case 2: //CYLINDRICAL_HORIZONTAL
                jQuery("#width").hide(); jQuery("#width").parent().hide(); jQuery("#width").parent().prev().hide();jQuery("#width").prop('required', false);
                jQuery("#length").show(); jQuery("#length").parent().show(); jQuery("#length").parent().prev().show();jQuery("#length").prop('required', true);
                jQuery("#diameter").show(); jQuery("#diameter").parent().show(); jQuery("#diameter").parent().prev().show();jQuery("#diameter").prop('required', true);
                jQuery("#height").hide(); jQuery("#height").parent().hide(); jQuery("#height").parent().prev().hide();jQuery("#height").prop('required', false);
                jQuery("#horizontal_axis").hide(); jQuery("#horizontal_axis").parent().hide(); jQuery("#horizontal_axis").parent().prev().hide();jQuery("#horizontal_axis").prop('required', false);
                jQuery("#vertical_axis").hide(); jQuery("#vertical_axis").parent().hide(); jQuery("#vertical_axis").parent().prev().hide();jQuery("#vertical_axis").prop('required', false);
                break;
            case 3: //CYLINDRICAL_VERTICAL
                jQuery("#width").hide(); jQuery("#width").parent().hide(); jQuery("#width").parent().prev().hide();jQuery("#width").prop('required', false);
                jQuery("#length").hide(); jQuery("#length").parent().hide(); jQuery("#length").parent().prev().hide();jQuery("#length").prop('required', false);
                jQuery("#diameter").show(); jQuery("#diameter").parent().show(); jQuery("#diameter").parent().prev().show();jQuery("#diameter").prop('required', true);
                jQuery("#height").show(); jQuery("#height").parent().show(); jQuery("#height").parent().prev().show();jQuery("#height").prop('required', true);
                jQuery("#horizontal_axis").hide(); jQuery("#horizontal_axis").parent().hide(); jQuery("#horizontal_axis").parent().prev().hide();jQuery("#horizontal_axis").prop('required', false);
                jQuery("#vertical_axis").hide(); jQuery("#vertical_axis").parent().hide(); jQuery("#vertical_axis").parent().prev().hide();jQuery("#vertical_axis").prop('required', false);
                break;
            case 4: //ELLIPTICAL
                jQuery("#width").hide(); jQuery("#width").parent().hide(); jQuery("#width").parent().prev().hide();jQuery("#width").prop('required', false);
                jQuery("#length").show(); jQuery("#length").parent().show(); jQuery("#length").parent().prev().show();jQuery("#length").prop('required', true);
                jQuery("#diameter").hide(); jQuery("#diameter").parent().hide(); jQuery("#diameter").parent().prev().hide();jQuery("#diameter").prop('required', false);
                jQuery("#height").hide(); jQuery("#height").parent().hide(); jQuery("#height").parent().prev().hide();jQuery("#height").prop('required', false);
                jQuery("#horizontal_axis").show(); jQuery("#horizontal_axis").parent().show(); jQuery("#horizontal_axis").parent().prev().show();jQuery("#horizontal_axis").prop('required', true);
                jQuery("#vertical_axis").show(); jQuery("#vertical_axis").parent().show(); jQuery("#vertical_axis").parent().prev().show();jQuery("#vertical_axis").prop('required', true);
                break;
            default:
                console.error("Uknown water tank type '" + type + "'");
        }
    }

    function disableOtherRunAndSiblingSuspend(program_checkbox, state, id)
    {
        if(program_checkbox.checked == false)
        {
            return;
        }

        // disable sibling suspend checkbox
        jQuery('#'+state+'_pr_suspend_'+id).prop('checked', false);
        // console.log("Unchecked " + '#'+state+'_pr_suspend_'+id);

        //uncheck other run programs in same state
        $for i in range(0, len(pnames)):
            jQuery('#'+state+'_pr_run_$i').prop('checked', false);
            // console.log("Unchecked " + '#'+state+'_pr_run_$i');

        jQuery('#'+state+'_pr_run_'+id).prop('checked', true);        
        // console.log("Checked " + '#'+state+'_pr_run_'+id);

        //uncheck other run stations in same state
        $for i in range(0, len(snames)):
            jQuery('#'+state+'_sn_run_$i').prop('checked', false);
            // console.log("Unchecked " + '#'+state+'_pr_run_$i');
    }

    function revertPrograms()
    {
        const id = jQuery("#original_water_tank_id").val();
        let water_tank = water_tank_data.find( w => {
            return w.id === id;
        });
        if(water_tank == null)
        {
            alert("Water tank with id " + id + " not found in water tank data");
        }
        
        if(!confirm("Revert will bring all programs as they were before the water tank entered state " +  getWaterTankStateName(water_tank.state)))
        {
            return;
        }

        jQuery.getJSON('water-tank-revert-programs', 
            {
                water_tank_id: id,
                state: water_tank.state
            },
            function(data){
            console.log('data:', data);
            water_tank_data = data;
            console.log('water_tank_data:', water_tank_data);

            $if water_tank_id:
                getWaterTankData("$water_tank_id");
            $else:
                jQuery("input[name=type][value=1]").click();
        });   
    }

    function uncheckRunPrograms(station_checkbox, state, id)
    {
        if(station_checkbox.checked == false)
        {
            return;
        }

        //uncheck other run programs in same state
        $for i in range(0, len(pnames)):
            jQuery('#'+state+'_pr_run_$i').prop('checked', false);
            // console.log("Unchecked " + '#'+state+'_pr_run_$i');
    }    


const LengthUnits = {
    CENTIMETERS : 1,
    METERS : 2,
    INCHES : 3,
    FEET : 4
}

function getUnitsText(units)
{
    switch(units)
    {
        case LengthUnits.CENTIMETERS: return " $_('cm')";
        case LengthUnits.METERS: return " $_('m')";
        case LengthUnits.INCHES: return " $_('in')";
        case LengthUnits.FEET: return " $_('feet')";
        default:
            console.log("Unknown units " + units);
            return null;
    }
}

function sensorUnitsSelected(units)
{
    let txt = getUnitsText(units);
    if(txt == null)
    {
        return;
    }
    jQuery("[name='sensor_units_txt']").text(txt);
}
function waterTankUnitsSelected(units)
{
    let txt = getUnitsText(units);
    if(txt == null)
    {
        return;
    }
    jQuery("[name='water_tank_units_txt'").text(txt);
}

</script>

<div id="plugin" class="water-tank">
    <div class="title">Water Tank Plugin
    <button class="execute" id="docButton" type="button" >$_('Help')</button>
    </div>
    <hr>
        <details>
            <summary>Stations, Sensors, MQTT, XMPP, Email, Messages</summary>
            <form id="pluginFormSettings" class="water-tank" action="/water-tank-save-settings" method="post">
                <h3>$_('Stations')</h3>
                <p class="info">$_('SIP will run stations if an OVERFLOW, WARNING, or CRITICAL percentage is reached. For such occassions this is the maximum allowed duration a station will run in minutes.')</p>
                <fieldset class="two-col">
                    <label>$_('Max Station Duration (mins)'):</label><input type="number" id="max_station_duration" name="max_station_duration" min="0" value="$settings['max_station_duration']" required/>
                </fieldset>
                <hr>
                <h3>$_('Sensors')</h3>
                <p class="info">$_('If a sensor has not sent a signal within the specified "no signal" minutes, SIP will flash the time-passed since last update under the water tank\'s name in the hompegage. In addition a message will be sent via email and/or xmpp (see "Dead-Sensor message" in messages).')</p> 
                <p class="info">$_('SIP will keep only the newest max sensor log records in the sensors log.')</p>
                <fieldset class="two-col">
                    <label>$_('Max Sensor No Signal (seconds)'):</label><input type="number" id="max_sensor_no_signal_time" name="max_sensor_no_signal_time" min="0" value="$settings['max_sensor_no_signal_time']" required/>
                    <label>$_('Max Sensor Log Records'):</label><input type="number" id="max_sensor_log_records" name="max_sensor_log_records" min="0" value="$settings['max_sensor_log_records']" required/>
                    <label>$_('Enable Sensor Logging')</label><input id="sensor_log_enabled" name="sensor_log_enabled" type="checkbox" ${'checked=checked' if settings['sensor_log_enabled'] else ''}/>
                </fieldset>
                <button id="sensorLog" class="log" title=$:{json.dumps(_('View Log'), ensure_ascii=False)}>$_('View Log')</button>
                <hr>
                <h3>MQTT</h3>
                <p class="info">$_('SIP will listen for incomming messages in the Subscribe topic. As soon as a message arrives, SIP will publish all water tank data to the Publish topic. The broker ws port is required for the Paho javascript library, please note that for a broker like mosquitto this is a different listener port than the standard 1883.')</p>
                <fieldset class="two-col">
                    <label>$_('Broker WS Port'):</label><input type="number" id="mqtt_broker_ws_port" name="mqtt_broker_ws_port" value="$settings['mqtt_broker_ws_port']"/>
                    <label>$_('Data-Request Subscribe Topic'):</label><input type="text" id="request_subscribe_mqtt_topic" name="request_subscribe_mqtt_topic" value="$settings['request_subscribe_mqtt_topic']"/>
                    <label>$_('Data-Publish Topic'):</label><input type="text" id="data_publish_mqtt_topic" name="data_publish_mqtt_topic" value="$settings['data_publish_mqtt_topic']"/>
                </fieldset>
                <hr>
                <h3>XMPP</h3>
                <p class="info">$_('SIP will send XMPP messages when it receives incomming MQTT messages from water-tank sensors. Recipients can be either a single xmpp account or a comma separated list of accounts.')</p>
                <fieldset class="two-col">
                    <label>$_('Username'):</label><input type="text" id="xmpp_username" name="xmpp_username" value="$settings['xmpp_username']"/>
                    <label>$_('Password'):</label><input type="text" id="xmpp_password" name="xmpp_password" value="$settings['xmpp_password']"/>
                    <label>$_('Server'):</label><input type="text" id="xmpp_server" name="xmpp_server" value="$settings['xmpp_server']"/>
                    <label>$_('Subject'):</label><input type="text" id="xmpp_subject" name="xmpp_subject" value="$settings['xmpp_subject']"/>
                    <label>$_('Recipients'):</label><input type="text" id="xmpp_recipients" name="xmpp_recipients" value="$settings['xmpp_recipients']"/>
                </fieldset>
                <hr>
                <h3>Email</h3>
                <p class="info">$_('SIP will send emails when it receives incomming MQTT messages from water-tank sensors. Recipients can be either a single email address or a comma separated list of email addresses.')</p>
                <fieldset class="two-col">
                    <label>$_('Username'):</label><input type="text" id="email_username" name="email_username" value="$settings['email_username']"/>
                    <label>$_('Password'):</label><input type="text" id="email_password" name="email_password" value="$settings['email_password']"/>
                    <label>$_('Server'):</label><input type="text" id="email_server" name="email_server" value="$settings['email_server']"/>
                    <label>$_('Server port'):</label><input type="number" id="email_server_port" name="email_server_port" value="$settings['email_server_port']"/>
                    <label>$_('Subject'):</label><input type="text" id="email_subject" name="email_subject" value="$settings['email_subject']"/>
                    <label>$_('Recipients'):</label><div><input type="text" id="email_recipients" name="email_recipients" value="$settings['email_recipients']"/></div>
                </fieldset>

                <hr>
                <h3>Messages</h3>
                <p class="info">$_('SIP will send messages (email and/or XMPP) for unassociated senson messages, invalid-sensor-measurement, overflow, warning, critical, and water-loss events.')</p>
                <p class="info">$_('For overflow, warning, and critical events messages will be resent only after the water level has crossed back over the event level. The list of allowed keywords that will be replaced by the corresponding values is: {water_tank_id}, {water_tank_label}, {sensor_id}, {percentage}, {measurement}, {last_updated}, {mqtt_topic}, {additional_info}. Keywords must be enclosed in curly brackets.')</p>
                <p class="info">$_('Keywords {water_tank_id},{water_tank_label},{percentage},{additional_info} are not valid for field "Unassociated-Sensor" message.')</p>
                <p class="info">$_('For field Unrecognised message valid are only keywords {mqtt_topic}, {date}, and {message}')</p>
                <fieldset class="two-col">
                    <div>
                        <label>$_('Unrecognised message'):</label>
                        <button type="button" class="reset" onclick='jQuery("#unrecognised_msg").val(defaults.unrecognised_msg);'>$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="unrecognised_msg" name="unrecognised_msg" data-exclude-keywords="water_tank_id,water_tank_label,sensor_id,percentage,measurement,last_updated,additional_info" data-extra-keywords="date,message">$settings['unrecognised_msg']</textarea>
                    </div>

                    <label>$_('Notify for unrecognised message')</label><div style="display:flex; flex-wrap: wrap;">
                        <label>Email<input id="unrecognised_msg_email" name="unrecognised_msg_email" type="checkbox" ${'checked=checked' if settings['unrecognised_msg_email'] else ''}/></label>
                        <label>Xmpp<input id="unrecognised_msg_xmpp" name="unrecognised_msg_xmpp" type="checkbox" ${'checked=checked' if settings['unrecognised_msg_xmpp'] else ''}/></label>
                    </div>

                    <div>
                        <label>$_('Dead-Sensor message'):</label>
                        <button type="button" class="reset" onclick='jQuery("#dead_sensor_msg").val(defaults.dead_sensor_msg);'>$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="dead_sensor_msg" name="dead_sensor_msg">$settings['dead_sensor_msg']</textarea>
                    </div>
                    <label>$_('Notify for dead sensors')</label><div style="display:flex; flex-wrap: wrap;">
                        <label>Email<input id="dead_sensor_email" name="dead_sensor_email" type="checkbox" ${'checked=checked' if settings['dead_sensor_email'] else ''}/></label>
                        <label>Xmpp<input id="dead_sensor_xmpp" name="dead_sensor_xmpp" type="checkbox" ${'checked=checked' if settings['dead_sensor_xmpp'] else ''}/></label>
                    </div>

                    <div>
                        <label>$_('Unassociated-Sensor message'):</label>
                        <button type="button" class="reset" onclick='jQuery("#xmpp_unassociated_sensor_msg").val(defaults.xmpp_unassociated_sensor_msg);'>$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="xmpp_unassociated_sensor_msg" name="xmpp_unassociated_sensor_msg" data-exclude-keywords="water_tank_id,water_tank_label,additional_info,percentage">$settings['xmpp_unassociated_sensor_msg']</textarea>
                    </div>

                    <label>$_('Notify for unassociated sensors')</label><div style="display:flex; flex-wrap: wrap;">
                        <label>Email<input id="unassociated_sensor_email" name="unassociated_sensor_email" type="checkbox" ${'checked=checked' if settings['unassociated_sensor_email'] else ''}/></label>
                        <label>Xmpp<input id="unassociated_sensor_xmpp" name="unassociated_sensor_xmpp" type="checkbox" ${'checked=checked' if settings['unassociated_sensor_xmpp'] else ''}/></label>
                    </div>

                    <div>
                        <label>$_('Invalid Sensor Measurement message'):</label>
                        <button type="button" class="reset" onclick="jQuery('#xmpp_invalid_sensor_measurement_msg').val(defaults.xmpp_invalid_sensor_measurement_msg);">$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="xmpp_invalid_sensor_measurement_msg" name="xmpp_invalid_sensor_measurement_msg">$settings['xmpp_invalid_sensor_measurement_msg']</textarea>
                    </div>
                    
                    <div>
                        <label>$_('Overflow message'):</label>
                        <button type="button" class="reset" onclick="jQuery('#xmpp_overflow_msg').val(defaults.xmpp_overflow_msg);">$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="xmpp_overflow_msg" name="xmpp_overflow_msg">$settings['xmpp_overflow_msg']</textarea>
                    </div>
                        
                    <div>
                        <label>$_('Warning message'):</label>
                        <button type="button" class="reset" onclick="jQuery('#xmpp_warning_msg').val(defaults.xmpp_warning_msg);">$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="xmpp_warning_msg" name="xmpp_warning_msg">$settings['xmpp_warning_msg']</textarea>
                    </div>
                        
                    <div>
                        <label>$_('Critical message'):</label>
                        <button type="button" class="reset" onclick="jQuery('#xmpp_critical_msg').val(defaults.xmpp_critical_msg);">$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="xmpp_critical_msg" name="xmpp_critical_msg">$settings['xmpp_critical_msg']</textarea>
                    </div>
                        
                    <div>
                        <label>$_('Water Loss message'):</label>
                        <button type="button" class="reset" onclick="jQuery('#water_loss_msg').val(defaults.water_loss_msg);">$_('reset')</button>
                    </div>
                    <div>
                        <textarea id="water_loss_msg" name="water_loss_msg">$settings['water_loss_msg']</textarea>
                    </div>
                        
                </fieldset>

                <div class="controls">
                    <button id="cUpdateSettings" class="submit"><b>$_('Update')</b></span>
                    <button id="cCancel" class="cancel danger">$_('Cancel')</button>
                </div>
                
            </form>
        </details>
        
        <hr>
    <form id="pluginFormWaterTanks" class="water-tank" action="/water-tank-save-water-tanks" method="post">
        <h3>$_('Water Tanks')</h3>
        <p class="info">Add, Edit, and Delete water tank records</p>
        <table>
            <thead>
                <tr>
                    <th>$_('ID')</th>
                    <th>$_('Label')</th>
                    <th>$_('Full')</th>
                    <th>$_('Last Update')</th>
                    <th>$_('Show')</th>
                    <th>$_('Order')</th>
                </tr>
            </thead>
            $for tank in settings['water_tanks'] :
                <tr onclick="getWaterTankData('$tank['id']')">
                    $ sensor_error = 'sensor_error' if tank['invalid_sensor_measurement'] else ''
                    <td class="$sensor_error">$tank['id']</td>
                    <td>$tank['label']</td>
                    $ str_percentage = str(round(float(tank['percentage']))) + '%' if tank['percentage'] else ''
                    <td>$str_percentage</td>
                    <td>$tank['last_updated']</td>
                    $ checked = 'checked="checked"' if tank['enabled'] else ''
                    <td><input type="checkbox" name="static" onclick="return false;" $checked/></td>
                    <td><span id="water-tank-up" style="font-size:1.5em;border: 1px solid black; border-radius:20%;">&#x25B2;</span>&nbsp;<span id="water-tank-down" style="font-size:1.5em;border: 1px solid black; border-radius:20%;">&#x25BC;</span></td>        
                </tr>
        </table>

        <h4>$_('Water Tank Details')</h4>
        <input type="hidden" id="original_water_tank_id" name="original_water_tank_id" value=""/>
        <input type="hidden" id="action" name="action" value="add"/>
        <fieldset class="two-col">
            <label>$_('Id'):</label><div><input type="text" id="id" name="id" value="" pattern="[a-zA-Z0-9_]+" title="$_('Only letters, numbers, and underscores are allowed')" required/></div>
            <label>$_('Label'):</label><div><input type="text" id="label" name="label" value="" required/></div>
            <label>$_('Type'):</label>
            <fieldset class="one-col">
                <label><input type="radio" name="type" value="1" hidden onClick="typeSelected(1)">$_('RECTANGULAR')</label>
                <label><input type="radio" name="type" value="2" hidden onClick="typeSelected(2)">$_('CYLINDRICAL_HORIZONTAL')</label>
                <label><input type="radio" name="type" value="3" hidden onClick="typeSelected(3)">$_('CYLINDRICAL_VERTICAL')</label>
                <label><input type="radio" name="type" value="4" hidden onClick="typeSelected(4)">$_('ELLIPTICAL')</label>
            </fieldset>
            <label>$_('Width'):</label><div><input type=number min=0 id="width" name="width" value=""/><span name="water_tank_units_txt"> $_('cm')</span></div>
            <label>$_('Length'):</label><div><input type=number min=0 id="length" name="length" value=""/><span name="water_tank_units_txt"> $_('cm')</span></div>
            <label>$_('Diameter'):</label><div><input type=number min=0 id="diameter" name="diameter" value=""/><span name="water_tank_units_txt"> $_('cm')</span></div>
            <label>$_('Height'):</label><div><input type=number min=0 id="height" name="height" value=""/><span name="water_tank_units_txt"> $_('cm')</span></div>
            <label>$_('Horizontal Axis'):</label><div><input type=number min=0 id="horizontal_axis" name="horizontal_axis" value=""/><span name="water_tank_units_txt"> $_('cm')</span></div>
            <label>$_('Vertical Axis'):</label><div><input type=number min=0 id="vertical_axis" name="vertical_axis" value=""/><span name="water_tank_units_txt"> $_('cm')</span></div>
            <label>$_('Sensor Mqtt Topic'):</label><div><input type=text id="sensor_mqtt_topic" name="sensor_mqtt_topic" value=""/></div>
            <label>$_('Sensor ID'):</label><div><input type=text id="sensor_id" name="sensor_id" required/></div>
            <label>$_('Sensor offset from top'):</label><div><input type=number id="sensor_offset_from_top" name="sensor_offset_from_top" value="0.0" required/><span name="water_tank_units_txt">$_('cm')</span></div>
            <label>$_('Min valid sesnor measurment'):</label><div><input type=number id="min_valid_sensor_measurement" name="min_valid_sensor_measurement" value=""/><span name="sensor_units_txt"> $_('cm')</span></div>
            <label>$_('Max valid sensor measurment'):</label><div><input type=number id="max_valid_sensor_measurement" name="max_valid_sensor_measurement" value=""/><span name="sensor_units_txt"> $_('cm')</span></div>
            <label>$_('Sensor measurment'):</label><div><input type=number id="sensor_measurement" name="sensor_measurement" value=""readonly/><span name="sensor_units_txt"> $_('cm')</span></div>
            <label>$_('Invalid sensor measurement'):</label><div><img src="/static/images/warning-icon24x24.png" id="invalid_sensor_measurement" name="invalid_sensor_measurement" style="visibility:hidden"/></div>
            <label>$_('Last updated'):</label><div><input type=text id="last_updated" name="last_updated" value="" readonly/></div>
            <label>$_('Full %'):</label><div><input type=number id="percentage" name="percentage" value="" readonly/></div>
            <label>$_('Sensor Units'):</label>
            <fieldset class="one-col">
                <label><input type="radio" name="sensor_units" value="1" hidden onclick="sensorUnitsSelected(LengthUnits.CENTIMETERS)">$_('CENTIMETERS')</label>
                <label><input type="radio" name="sensor_units" value="2" hidden onclick="sensorUnitsSelected(LengthUnits.METERS)">$_('METERS')</label>
                <label><input type="radio" name="sensor_units" value="3" hidden onclick="sensorUnitsSelected(LengthUnits.INCHES)">$_('INCHES')</label>
                <label><input type="radio" name="sensor_units" value="4" hidden onclick="sensorUnitsSelected(LengthUnits.FEET)">$_('FEET')</label>
            </fieldset>
            <label>$_('Water Tank Units'):</label>
            <fieldset class="one-col">
                <label><input type="radio" name="water_tank_units" value="1" hidden onclick="waterTankUnitsSelected(LengthUnits.CENTIMETERS)">$_('CENTIMETERS')</label>
                <label><input type="radio" name="water_tank_units" value="2" hidden onclick="waterTankUnitsSelected(LengthUnits.METERS)">$_('METERS')</label>
                <label><input type="radio" name="water_tank_units" value="3" hidden onclick="waterTankUnitsSelected(LengthUnits.INCHES)">$_('INCHES')</label>
                <label><input type="radio" name="water_tank_units" value="4" hidden onclick="waterTankUnitsSelected(LengthUnits.FEET)">$_('FEET')</label>
            </fieldset>
            <label>$_('Enabled'):</label><div><input type="checkbox" id="enabled" name="enabled"/></div>
            <label>$_('Notify for invalid measurements'):</label><div style="display:flex; flex-wrap: wrap;">
                <label>Email<input id="invalid_sensor_measurement_email" name="invalid_sensor_measurement_email" type="checkbox"/></label>
                <label>Xmpp<input id="invalid_sensor_measurement_xmpp" name="invalid_sensor_measurement_xmpp" type="checkbox"/></label>
            </div>
        </fieldset>

        <h4>$_('Water Loss')</h4>
        <p class="info">$_('When sensors report decreasing water level but no valves are open, water is leaking or being stolen. Specify which emails and xmpp accounts to notify.')</p>
        <fieldset class="two-col">
            <label>$_('Notify'):</label><div style="display:flex; flex-wrap: wrap;">
                <label>Email<input id="loss_email" name="loss_email" type="checkbox"/></label>
                <label>Xmpp<input id="loss_xmpp" name="loss_xmpp" type="checkbox"/></label>
            </div>
        </fieldset>

        <h4>$_('Water Tank States')</h4>

        <p class="info">$_('Specify water levels (% of total water tank volume) at which the water tank enters OVERFLOW, WARNING, and CRITICAL state.')</p>
        <p class="info">$_('Specify a corresponding SAFETY level that must be crossed in order to consider the state as exited.')</p>
        <p class="info">$_('Specify programs to run, be enabled, suspended when entering a state. The program status will be reverted upon exiting the state.')</p>
        <p class="info">$_('Specify stations that will run for a specific amount of time, or until a certain percentage is crossed, or until the state is exited - whatever comes first.')</p>
        <p class="info">$_('Specify which emails and xmpp accounts to notify when entering a state.')</p>

        <div><span name="overflow_flash" class="flash-event" hidden>&#x26A1;</span><h4>$_('Overflow')</h4><span name="overflow_flash" class="flash-event" hidden>&#x26A1;</span></div>
        <fieldset class="two-col">            
            <label>$_('Overflow Level'):</label><div><input id="overflow_level" name="overflow_level" type=number min=0 max=100/></div>
            <label>$_('Safe level'):</label><div><input id="overflow_safe_level" name="overflow_safe_level" type=number min=0 max=100/></div>
            <label>$_('Notify'):</label><div style="display:flex; flex-wrap: wrap;">
                <label>Email<input id="overflow_email" name="overflow_email" type="checkbox"/></label>
                <label>Xmpp<input id="overflow_xmpp" name="overflow_xmpp" type="checkbox"/></label>
            </div>
            <div>
                <label>$_('Programs'):</label>
                <button id="overflow_revert_button" type="button" class="revert" onclick='revertPrograms()' disabled>$_('Revert')</button>
            </div>
            <div style="display:flex; flex-wrap: wrap; width: fit-content;">
                $for i in range(0, len(pnames)):
                    <label class="program">$pnames[i]
                        <label class="program-action"><input id="overflow_pr_run_$i" name="overflow_pr_run_$i" type="checkbox" onclick="disableOtherRunAndSiblingSuspend(this,'overflow',$i);"/>$_('Run')</label>
                        <label class="program-action"><input id="overflow_pr_enable_$i" name="overflow_pr_enable_$i" type="checkbox" onclick="jQuery('#overflow_pr_suspend_$i').prop('checked', false);"/>$_('Enable')</label>
                        <label class="program-action"><input id="overflow_pr_suspend_$i" name="overflow_pr_suspend_$i" type="checkbox" onclick="jQuery('#overflow_pr_run_$i, #overflow_pr_enable_$i').prop('checked', false);"/>$_('Suspend')</label>
                    </label>
            </div>
            <div>
                <label>$_('Stations'):</label>
            </div>
            <div style="display:flex; flex-wrap: wrap; width: fit-content;">
                $for i in range(0, len(snames)):
                $ show = (gv.sd['show'][i//8]>>(i%8))&1
                    $if show == 1:
                        <div class="station">
                            <label class="station">
                                <input class="station_run" id="overflow_sn_run_$i" name="overflow_sn_run_$i" type="checkbox" onclick="uncheckRunPrograms(this,'overflow',$i);"/>
                                $snames[i]
                            </label>
                            <label class="station-action">
                                <input class="duration" id="overflow_sn_minutes_$i" name="overflow_sn_minutes_$i" type="number" min="0" max="$settings['max_station_duration']"/>$_('Mins')
                            </label>
                            <label class="station-action"><input class="percentage" id="overflow_sn_percentage_$i" name="overflow_sn_percentage_$i" type="number" min="0" max="100"/>$_('%')</label>
                            <label class="station-action"><input class="stop" id="overflow_sn_stop_on_exit_$i" name="overflow_sn_stop_on_exit_$i" type="checkbox"/>$_('State Exit')</label>
                        </div>             
            </div>     
        </fieldset>

        <div><span name="warning_flash" class="flash-event" hidden>&#x26A1;</span><h4>$_('Warning')</h4><span name="warning_flash" class="flash-event" hidden>&#x26A1;</span></div>
        <fieldset class="two-col">
            <label>$_('Level'):</label><div><input id="warning_level" name="warning_level" type=number min=0 max=100/></div>
            <label>$_('Safe level'):</label><div><input id="warning_safe_level" name="warning_safe_level" type=number min=0 max=100/></div>
            <label>$_('Notify'):</label><div style="display:flex; flex-wrap: wrap;">
                <label>Email<input id="warning_email" name="warning_email" type="checkbox"/></label>
                <label>Xmpp<input id="warning_xmpp" name="warning_xmpp" type="checkbox"/></label>
            </div>
            <div>
                <label>$_('Programs'):</label>
                <button  id="warning_revert_button"type="button" class="revert" onclick='revertPrograms()' disabled>$_('Revert')</button>
            </div>
            <div style="display:flex; flex-wrap: wrap; width: fit-content;">
                $for i in range(0, len(pnames)):
                <label class="program">$pnames[i]
                    <label class="program-action"><input id="warning_pr_run_$i" name="warning_pr_run_$i" type="checkbox" onclick="disableOtherRunAndSiblingSuspend(this,'warning',$i);"/>$_('Run')</label>
                    <label class="program-action"><input id="warning_pr_enable_$i" name="warning_pr_enable_$i" type="checkbox" onclick="jQuery('#warning_pr_suspend_$i').prop('checked', false);"/>$_('Enable')</label>
                    <label class="program-action"><input id="warning_pr_suspend_$i" name="warning_pr_suspend_$i" type="checkbox" onclick="jQuery('#warning_pr_run_$i, #warning_pr_enable_$i').prop('checked', false);"/>$_('Suspend')</label>
                </label>
            </div>
            <div>
                <label>$_('Stations'):</label>
            </div>
            <div style="display:flex; flex-wrap: wrap; width: fit-content;">
                $for i in range(0, len(snames)):
                $ show = (gv.sd['show'][i//8]>>(i%8))&1
                    $if show == 1:
                        <div class="station">
                            <label class="station">
                                <input class="station_run" id="warning_sn_run_$i" name="warning_sn_run_$i" type="checkbox" onclick="uncheckRunPrograms(this,'warning',$i);"/>
                                $snames[i]
                            </label>
                            <label class="station-action">
                                <input class="duration" id="warning_sn_minutes_$i" name="warning_sn_minutes_$i" type="number" min="0" max="$settings['max_station_duration']"/>$_('Mins')</label>
                            <label class="station-action"><input class="percentage" id="warning_sn_percentage_$i" name="warning_sn_percentage_$i" type="number" min="0" max="100"/>$_('%')</label>   
                            <label class="station-action"><input class="stop" id="warning_sn_stop_on_exit_$i" name="warning_sn_stop_on_exit_$i" type="checkbox"/>$_('State Exit')</label>
                        </div>             
            </div> 
        </fieldset>

        <div><span name="critical_flash" class="flash-event" hidden>&#x26A1;</span><h4>$_('Critical')</h4><span name="critical_flash" class="flash-event" hidden>&#x26A1;</span></div>
        <fieldset class="two-col">
            <label>$_('Level'):</label><div><input id="critical_level" name="critical_level" type=number min=0 max=100/></div>
            <label>$_('Safe level'):</label><div><input id="critical_safe_level" name="critical_safe_level" type=number min=0 max=100/></div>
            <label>$_('Notify'):</label><div style="display:flex; flex-wrap: wrap;">
                <label>Email<input id="critical_email" name="critical_email" type="checkbox"/></label>
                <label>Xmpp<input id="critical_xmpp" name="critical_xmpp" type="checkbox"/></label>
            </div>
            <div>
                <label>$_('Programs'):</label>
                <button id="critical_revert_button" type="button" class="revert" onclick='revertPrograms()' disabled>$_('Revert')</button>
            </div>
            <div style="display:flex; flex-wrap: wrap; width: fit-content;">
                $for i in range(0, len(pnames)):
                <label class="program">$pnames[i]
                    <label class="program-action"><input id="critical_pr_run_$i" name="critical_pr_run_$i" type="checkbox" onclick="disableOtherRunAndSiblingSuspend(this,'critical',$i);"/>$_('Run')</label>
                    <label class="program-action"><input id="critical_pr_enable_$i" name="critical_pr_enable_$i" type="checkbox" onclick="jQuery('#critical_pr_suspend_$i').prop('checked', false);"/>$_('Enable')</label>
                    <label class="program-action"><input id="critical_pr_suspend_$i" name="critical_pr_suspend_$i" type="checkbox" onclick="jQuery('#critical_pr_run_$i, #critical_pr_enable_$i').prop('checked', false);"/>$_('Suspend')</label>
                </label>
            </div>           
            <div>
                <label>$_('Stations'):</label>
            </div>
            <div style="display:flex; flex-wrap: wrap; width: fit-content;">
                $for i in range(0, len(snames)):
                $ show = (gv.sd['show'][i//8]>>(i%8))&1
                    $if show == 1:
                        <div class="station">
                            <label class="station">
                                <input class="station_run" id="critical_sn_run_$i" name="critical_sn_run_$i" type="checkbox" onclick="uncheckRunPrograms(this,'critical',$i);"/>
                                $snames[i]
                            </label>
                            <label class="station-action">
                                <input class="duration" id="critical_sn_minutes_$i" name="critical_sn_minutes_$i" type="number" min="0" max="$settings['max_station_duration']"/>$_('Mins')</label>
                            <label class="station-action"><input class="percentage" id="critical_sn_percentage_$i" name="critical_sn_percentage_$i" type="number" min="0" max="100"/>$_('%')</label>  
                            <label class="station-action"><input class="stop" id="critical_sn_stop_on_exit_$i" name="critical_sn_stop_on_exit_$i" type="checkbox"/>$_('State Exit')</label>
                        </div>             
            </div>          
        </fieldset>

        </br>
        <div class="controls">
            <button id="cAddNew" class="submit"><b>$_('Add New')</b></button>
            <button id="cUpdate" class="submit" disabled="true"><b>$_('Update')</b></button>
            <button id="cDelete" class="submit danger" disabled="true"><b>$_('Delete')</b></button>
            <button id="cCancel" class="cancel danger">$_('Cancel')</button>
        </div>
        
    </form>
    <!--Use the following button to validate the water-tank form without submitting so you have time to see the error messages-->
    <!-- <button id="cUpdate" onclick="jQuery('#pluginFormWaterTanks').valid();" disabled="true"><b>$_('Update')</b></button> -->

</div>
